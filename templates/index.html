<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Reviewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary shadow-sm mb-5">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">üçΩÔ∏è Nithya's Kitchen review</a>
            <a href="/history" class="btn btn-outline-light btn-sm">History</a>
        </div>
    </nav>

    <div class="container" style="max-width: 500px;">
        <div class="card shadow border-0 p-4">
            <h3 class="text-center mb-4">Leave a Review</h3>
            
            <div class="mb-3">
                <label class="form-label">Your Name</label>
                <input type="text" id="username" class="form-control" placeholder="Enter name to unlock mic">
            </div>

            <div class="text-center my-4">
                <button id="micBtn" class="btn btn-danger btn-lg rounded-circle" style="width: 80px; height: 80px;">
                    üé§
                </button>
                <p id="status" class="mt-3 text-muted">Enter your name to start</p>
            </div>

            <div id="resultArea" class="d-none border-top pt-4">
                <p class="small text-uppercase text-muted fw-bold">Detected Text:</p>
                <p id="transcript" class="fst-italic bg-white p-2 border rounded"></p>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <span id="sentimentLabel" class="badge rounded-pill px-3 py-2"></span>
                    <span class="text-muted">Score: <strong id="scoreVal"></strong></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const micBtn = document.getElementById('micBtn');
        const usernameInput = document.getElementById('username');
        const statusText = document.getElementById('status');
        
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';

        micBtn.onclick = () => {
            if (!usernameInput.value.trim()) {
                alert("Please enter your name first.");
                return;
            }
            recognition.start();
            micBtn.classList.add('mic-active');
            statusText.innerText = "Listening to your review...";
        };

        recognition.onresult = async (event) => {
            micBtn.classList.remove('mic-active');
            const text = event.results[0][0].transcript;
            statusText.innerText = "Processing analysis...";

            const response = await fetch('/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: usernameInput.value, text: text })
            });
            
            const data = await response.json();
            
            document.getElementById('resultArea').classList.remove('d-none');
            document.getElementById('transcript').innerText = `"${text}"`;
            document.getElementById('scoreVal').innerText = data.score;
            
            const label = document.getElementById('sentimentLabel');
            label.innerText = data.label;
            label.className = `badge rounded-pill px-3 py-2 ${data.label === 'Positive' ? 'bg-success' : data.label === 'Negative' ? 'bg-danger' : 'bg-warning text-dark'}`;
            
            statusText.innerText = "Saved to database!";
        };

        recognition.onerror = () => {
            micBtn.classList.remove('mic-active');
            statusText.innerText = "Error occurred. Try again.";
        };
    </script>
    <script src="/static/js/main.js"></script>
</body>
</html>